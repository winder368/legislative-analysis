<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>立法院法案查詢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .article-card {
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .article-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .bills-count {
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">立法院法案查詢</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm" class="row g-3">
                    <div class="col-md-6">
                        <label for="lawName" class="form-label">法律名稱</label>
                        <input type="text" class="form-control" id="lawName" name="law_name" required>
                    </div>
                    <div class="col-md-4">
                        <label for="term" class="form-label">屆別</label>
                        <select class="form-select" id="term" name="term" required>
                            <option value="">請選擇屆別</option>
                            {% for term in terms %}
                            <option value="{{ term }}">第 {{ term }} 屆</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">查詢</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="results" class="d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">修正條文</h2>
                <span id="totalCount" class="text-muted"></span>
            </div>
            <div id="articlesList" class="row"></div>
        </div>

        <div id="loading" class="text-center d-none">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const lawName = document.getElementById('lawName').value;
            const term = document.getElementById('term').value;
            
            // 顯示載入中
            document.getElementById('loading').classList.remove('d-none');
            document.getElementById('results').classList.add('d-none');
            
            try {
                const response = await fetch(`/search?law_name=${encodeURIComponent(lawName)}&term=${encodeURIComponent(term)}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // 顯示結果
                const articlesList = document.getElementById('articlesList');
                articlesList.innerHTML = '';
                
                if (data.articles.length === 0) {
                    articlesList.innerHTML = '<div class="col-12"><div class="alert alert-info">沒有找到相關條文修正</div></div>';
                } else {
                    document.getElementById('totalCount').textContent = `共 ${data.total} 個修正提案`;
                    
                    // 先顯示有條號的修正
                    const numberedArticles = data.articles.filter(a => a.article !== '其他修正');
                    if (numberedArticles.length > 0) {
                        const numberedTitle = document.createElement('div');
                        numberedTitle.className = 'col-12 mb-3';
                        numberedTitle.innerHTML = '<h3>個別條文修正</h3>';
                        articlesList.appendChild(numberedTitle);
                        
                        // 按照提案數量排序
                        numberedArticles.sort((a, b) => b.bills_count - a.bills_count);
                        
                        numberedArticles.forEach(article => {
                            // 將中文數字轉換為阿拉伯數字
                            const displayArticle = article.article.replace(/第([零一二三四五六七八九十百千]+)條/, (match, num) => {
                                const digits = {
                                    '零': 0, '一': 1, '二': 2, '三': 3, '四': 4,
                                    '五': 5, '六': 6, '七': 7, '八': 8, '九': 9,
                                    '十': 10
                                };
                                
                                // 處理特殊情況
                                if (num === '十') return '第10條';
                                
                                // 處理十幾、幾十的情況
                                if (num.includes('十')) {
                                    if (num.length === 2) {
                                        if (num.startsWith('十')) {
                                            return `第${10 + (digits[num[1]] || 0)}條`;
                                        } else {
                                            return `第${digits[num[0]] * 10}條`;
                                        }
                                    } else if (num.length === 3 && num[1] === '十') {
                                        return `第${digits[num[0]] * 10 + digits[num[2]]}條`;
                                    }
                                }
                                
                                // 處理一般情況
                                let result = 0;
                                let unit = 1;
                                for (let i = num.length - 1; i >= 0; i--) {
                                    if (num[i] === '百') {
                                        unit = 100;
                                    } else if (num[i] === '千') {
                                        unit = 1000;
                                    } else if (digits[num[i]] !== undefined) {
                                        result += digits[num[i]] * unit;
                                        unit = 1;
                                    }
                                }
                                return `第${result}條`;
                            }).replace(/之([零一二三四五六七八九十百千]+)/, (match, num) => {
                                const digits = {
                                    '零': 0, '一': 1, '二': 2, '三': 3, '四': 4,
                                    '五': 5, '六': 6, '七': 7, '八': 8, '九': 9,
                                    '十': 10
                                };
                                
                                // 處理特殊情況
                                if (num === '十') return '之10';
                                
                                // 處理十幾、幾十的情況
                                if (num.includes('十')) {
                                    if (num.length === 2) {
                                        if (num.startsWith('十')) {
                                            return `之${10 + (digits[num[1]] || 0)}`;
                                        } else {
                                            return `之${digits[num[0]] * 10}`;
                                        }
                                    } else if (num.length === 3 && num[1] === '十') {
                                        return `之${digits[num[0]] * 10 + digits[num[2]]}`;
                                    }
                                }
                                
                                return `之${digits[num] || num}`;
                            });
                            
                            const col = document.createElement('div');
                            col.className = 'col-md-4';
                            col.innerHTML = `
                                <div class="card article-card" onclick="window.location.href='/article?law_name=${encodeURIComponent(lawName)}&term=${encodeURIComponent(term)}&article=${encodeURIComponent(article.article)}'">
                                    <div class="card-body">
                                        <h5 class="card-title">${displayArticle}</h5>
                                        <p class="bills-count mb-0">
                                            ${article.bills_count} 個修正提案
                                        </p>
                                    </div>
                                </div>
                            `;
                            articlesList.appendChild(col);
                        });
                    }
                    
                    // 再顯示其他修正
                    const otherArticles = data.articles.filter(a => a.article === '其他修正');
                    if (otherArticles.length > 0) {
                        const otherTitle = document.createElement('div');
                        otherTitle.className = 'col-12 mt-4 mb-3';
                        otherTitle.innerHTML = '<h3>其他修正</h3>';
                        articlesList.appendChild(otherTitle);
                        
                        otherArticles.forEach(article => {
                            const col = document.createElement('div');
                            col.className = 'col-12';
                            col.innerHTML = `
                                <div class="card article-card" onclick="window.location.href='/article?law_name=${encodeURIComponent(lawName)}&term=${encodeURIComponent(term)}&article=${encodeURIComponent(article.article)}'">
                                    <div class="card-body">
                                        <h5 class="card-title">其他修正案</h5>
                                        <p class="bills-count mb-0">
                                            ${article.bills_count} 個修正提案
                                        </p>
                                    </div>
                                </div>
                            `;
                            articlesList.appendChild(col);
                        });
                    }
                }
                
                document.getElementById('results').classList.remove('d-none');
            } catch (error) {
                alert('查詢時發生錯誤，請稍後再試');
            } finally {
                document.getElementById('loading').classList.add('d-none');
            }
        });
    </script>
</body>
</html> 